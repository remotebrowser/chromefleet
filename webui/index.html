<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrome Fleet</title>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@4/dist/timeago.min.js"></script>
</head>

<body>
    <h1>Chrome Fleet</h1>
    <p id="status">Loading...</p>
    <div id="browsers-grid"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;"></div>
    <script>
        const $ = id => document.getElementById(id);

        const listBrowsers = async () => {
            const response = await fetch('/api/v1/browsers');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        };

        const getBrowser = async id => {
            const response = await fetch(`/api/v1/browsers/${id}`);
            const data = await response.json();
            return data.ip_address ? data : null;
        };

        const formatTimestamp = timestamp => timestamp ? timeago.format(new Date(timestamp * 1000)) : '-';

        const update = async () => {
            try {
                const browsers = await listBrowsers();
                if (!Array.isArray(browsers)) {
                    throw new Error('Invalid response: expected array of browsers');
                }
                const status = $('status');
                status.textContent = browsers.length === 0 ? 'No browsers running!' : `${browsers.length} browser(s) running:`;
                const grid = $('browsers-grid');
                grid.innerHTML = '';
                browsers.forEach(browserId => {
                    const container = document.createElement('div');
                    container.style.padding = '10px';
                    container.id = browserId;

                    const infoDiv = document.createElement('div');
                    infoDiv.style.marginBottom = '10px';

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = `${browserId} `;
                    nameSpan.style.fontWeight = 'bold';
                    infoDiv.appendChild(nameSpan);

                    const ipSpan = document.createElement('a');
                    ipSpan.textContent = '';
                    ipSpan.id = `${browserId}-ip`;
                    ipSpan.style.color = '#0066cc';
                    ipSpan.target = '_blank';
                    infoDiv.appendChild(ipSpan);

                    const activitySpan = document.createElement('span');
                    activitySpan.textContent = '';
                    activitySpan.id = `${browserId}-activity`;
                    activitySpan.style.fontSize = '0.8em';
                    activitySpan.style.color = '#666';
                    activitySpan.style.marginLeft = '10px';
                    infoDiv.appendChild(activitySpan);

                    const iframe = document.createElement('iframe');
                    iframe.src = 'about:blank';
                    iframe.style.width = '100%';
                    iframe.style.aspectRatio = '16 / 9';
                    iframe.style.border = '1px solid #888';
                    iframe.id = `${browserId}-iframe`;

                    const iframeContainer = document.createElement('div');
                    iframeContainer.style.position = 'relative';
                    iframeContainer.style.width = '100%';

                    const overlay = document.createElement('div');
                    overlay.style.position = 'absolute';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.width = '100%';
                    overlay.style.height = '100%';
                    overlay.style.zIndex = '1';
                    overlay.style.backgroundColor = 'transparent';

                    iframeContainer.appendChild(iframe);
                    iframeContainer.appendChild(overlay);

                    container.appendChild(infoDiv);
                    container.appendChild(iframeContainer);
                    grid.appendChild(container);
                });
                for (const id of browsers) {
                    const browser = await getBrowser(id);
                    const container = $(id);
                    if (browser && container) {
                        const ipSpan = $(`${id}-ip`);
                        const activitySpan = $(`${id}-activity`);
                        const iframe = $(`${id}-iframe`);
                        if (ipSpan) {
                            ipSpan.textContent = ` (${browser.ip_address})`;
                            ipSpan.href = `http://${browser.ip_address}`;
                        }
                        if (activitySpan) {
                            activitySpan.textContent = ` ${formatTimestamp(browser.last_activity_timestamp)}`;
                        }
                        if (iframe) {
                            iframe.src = `http://${browser.ip_address}`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching browsers:', error);
                $('status').textContent = 'Error loading browsers';
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            update();
            setInterval(update, 60 * 1000);
        });
    </script>
</body>

</html>